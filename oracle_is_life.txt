setxbmap cz

unset TWO_TASK
  sqlplus / as sysdba  ||  rman target / (RMAN je nutné restartovat pokud restartujeme DB)

ORACLE_HOME = /u01/app/oracle/product/12.1.0.2/db_1

jednotlivé kroky (schody) = startup nomount, alter database mount, alter database open

  Nastavení DB pro zálohování:

1) zapnutí ARCHIVELOG mod v SQLPLUS
SQL> select log_mode from v$database; (zjistíme NOARCHIVELOG / ARCHIVELOG)
SQL> shutdown immediate;
SQL> startup mount;
SQL> alter database archivelog;
SQL> alter database open;

2) multiplexace řídících souborů (zapnuto by default, není třeba dělat pokud není výslovně řečeno)
SQL> show parameter control; (zobrazí cesty k řídicím souborům, jeden z nich kopírujeme třeba do /home/oracle/control03.ctl)
SQL> shutdown immediate;
SQL> create pfile from spfile; (vytvoří inicializační soubor pro čtení, DB nesmí běžet)
- cesta k pfile souboru: /u01/app/oracle/product/12.1.0.2/db_1/dbs/initorcl12c.ora
- upravíme řádek *.control_files='/u01/app/oracle/oradata/orcl12c/control01.ctl','/u01/app/oracle/fast_recovery_area/orcl12c/control02.ctl', '/home/oracle/control03.ctl'
- uložíme pfile soubor
SQL> create spfile from pfile;
SQL> startup;

SQL> ALTER DATABASE BACKUP CONTROLFILE TO TRACE; (další způsob jak zálohovat control file)
SQL> ALTER DATABASE BACKUP CONTROLFILE TO '/home/oracle/manual/control.ctl'; (manuální záloha řídícího souboru)

RMAN> show all; (mělo by být CONFIGURE CONTROLFILE AUTOBACKUP ON)
RMAN> CONFIGURE CONTROLFILE AUTOBACKUP ON; (kdyby náhodou nebylo)

3) nastavení maximální velikosti pro zálohu (asi není nutné pokud budeme dělat pouze jednu zálohu)
SQL> show parameter reco; (ukáže aktuální nastavení záloh)
- nalezneme zde i cestu kam se ukládají zálohy /u01/app/oracle/fast_recovery_area
SQL> alter system set db_recovery_file_dest_size=10G;

4) multiplexace redologů (nejspíš nutná pokud bychom o nějaký přišli)
SQL> column member format a50 (úpravy formátování)
SQL> set linesize 180
SQL> select * from v$logfile; (ukáže nám cesty k redologům)
SQL> alter database add logfile member '/home/oracle/redo01.log' to group 1; (duplikace redologu 1, 2, 3)
SQL> alter database add logfile member '/home/oracle/redo02.log' to group 2;
SQL> alter database add logfile member '/home/oracle/redo03.log' to group 3;
- duplikované redology jsou ve stavu invalid
SQL> alter system switch logfile; (spustíme 3x abychom je dali do funkčního stavu)
- pokud smažeme jeden z šesti redologů poznáme to po restartu DB, že některá bude invalid

5) zálohování samotné DB
CREATE TABLE persons (id int, name varchar(255)); (přidáme nějaká ukázková data)
INSERT INTO persons VALUES (1, 'pepa');
INSERT INTO persons VALUES (2, 'karel');
commit;

RMAN> backup as backupset database
RMAN> backup as compressed backupset database
RMAN> backup as copy database

  Obnova DB:

1) kompletní obnova ze zálohy (je potřeba mít vyplou DB)
RMAN> startup nomount;
RMAN> restore controlfile from autobackup;
RMAN> alter database mount;
RMAN> restore database;
RMAN> recover database;
RMAN> alter database open resetlogs;

2) ruční kontrola souborů v /u01/app/oracle/oradata/orcl12c/
- může zde chybět control file (control01.ctl)
- měli by tu být 3 redology (redo123.log)

3) použití RMAN pro identifikaci problému (z vypnuté DB)
RMAN> startup nomount; (pokud tohle nejde nejspíš je problém s inicializačním souborem)
RMAN> list failure; (ukáže nalezené chyby a nekonzistence v souborech)
RMAN> advise failure; (ukáže možná řešení chyb)
RMAN> repair failure preview; (vytiskne pomocný skript, který by měl opravit problém, pak už jen kopírovat příkazy odsud)

4) zkontrolování alert logů z /u01/app/oracle/diag/rdbms/orcl12c/orcl12c/trace/alert_orcl12c.log

5) zeptat se kde je funkční spfile
